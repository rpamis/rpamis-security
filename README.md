<p align="center">
  <img
    src="img/logo.png"
    alt="Logo"
    width="200"
  />
</p>

<h3 align="center">A mybatis encryption, decryption and desensitization component</h3>

<p align="center">
  <a href="README-zh.md">‰∏≠Êñá</a>
  &nbsp;|&nbsp;
  <a href="README.md">English</a>
</p>

<p align="center">
  <a href="https://central.sonatype.com/artifact/com.rpamis/rpamis-security-spring-boot-starter/1.1.0">
    <img alt="maven" src="https://img.shields.io/maven-central/v/com.rpamis/rpamis-security-spring-boot-starter?style=flat-square">
  </a>


  <a href="https://www.apache.org/licenses/LICENSE-2.0">
    <img alt="code style" src="https://img.shields.io/badge/license-Apache%202-4EB1BA.svg?style=flat-square">
  </a>

  <a href="https://app.codecov.io/github/rpamis/rpamis-security" > 
    <img alt="codecov" src="https://img.shields.io/codecov/c/gh/rpamis/rpamis-security?color=%23&style=flat-square"/> 
  </a>

  <a href="https://deepwiki.com/rpamis/rpamis-security">
    <img alt="code style" src="https://deepwiki.com/badge.svg">
  </a>
</p>

---

üéÑRpamis-security is a security component developed based on Mybatis plugin, designed to provide superior enterprise data security solutions such as desensitization, encryption/decryption for database storage, etc. The component provides annotation-based programming, allowing developers to simply add corresponding annotations to fields or methods that need processing, without concerning about security-related requirements. The component automatically completes functions such as desensitization, encryption/decryption, etc.

## Principle Analysis
[Rpamis-security Technical Background](https://benym.cn/notes/08-open-source-project/01-rpamis/03-security/02-rpamis-security-technical-background)

[Rpamis-security Principle Analysis](https://benym.cn/notes/08-open-source-project/01-rpamis/03-security/03-rpamis-security-principle-analysis)

### Quick Start

SpringBoot project integration method

JDK17 and above
```xml
<dependency>
    <groupId>com.rpamis</groupId>
    <artifactId>rpamis-security-spring-boot-starter</artifactId>
    <version>1.1.0</version>
</dependency>
```

JDK8-JDK17
```xml
<dependency>
    <groupId>com.rpamis</groupId>
    <artifactId>rpamis-security-spring-boot-starter</artifactId>
    <version>1.0.3</version>
</dependency>
```
yml configuration

```yaml
rpamis:
  # rpamis-security configuration
  security:
    # Whether to enable security component, database encryption, decryption when retrieving, if encryption algorithm is not specified, return original value by default
    # When this switch is false, regardless of whether desensitization aspect is enabled, it will not take effect
    enable: true
    # Ignore decryption failure, return original value if decryption fails, otherwise throw exception, if not specified default is true
    ignore-decrypt-failed: true
    # Whether to enable desensitization aspect
    desensitization-enable: true
    # Custom pointcut, such as adding RestController pointcut
    custom-pointcut: '@within(org.springframework.web.bind.annotation.RestController)'
    # Encryption/decryption algorithm
    algorithm:
      # Active encryption algorithm
      active: sm4
      sm4:
        # Encryption algorithm key, needs to be generated by yourself, meet 16 digits, below is just an example
        key: 2U43wVWjLgToKBzG
        # Unique identification prefix for encryption/decryption
        prefix: Your_CUSTOM_PREFIX_
```

Component Features

| rpamis-security                                          | Component Advantages                                         | Similar Projects                                             |
| -------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Supports desensitization of arbitrary entity types       | ‚úÖCustom entities, List, Map, regardless of whether they have entity generics, **as long as the return value contains desensitization annotations, desensitization is supported**, **not Jackson serialization solution, does not affect global Jackson output behavior** | **‚ùåSupports only single entity desensitization, cannot desensitize when generics are not specified**, **Jackson serialization solution, may affect Jackson output behavior** |
| Supports nested desensitization of arbitrary entity types| ‚úÖFor entities marked with nested desensitization annotations, their internal custom entities, List, Map, regardless of whether they have entity generics, **as long as the return value contains desensitization annotations, desensitization is supported** | **‚ùåDoes not support nested desensitization**                  |
| Supports automatic encryption/decryption of arbitrary entity type data for database storage | ‚úÖFor **any entity marked with encrypted fields**, automatic encryption occurs when entering Mybatis/MybatisPlus for database storage, **automatic decryption when data is retrieved from database, supports dynamic SQL encryption/decryption** | ‚ùåSupports only single entity automatic encryption/decryption, **cannot support automatic encryption/decryption of multiple entities in List, Map**, **cannot support dynamic SQL encryption/decryption** |
| Supports national standard encryption algorithm Sm4        | Supports national cryptography Sm4 symmetric encryption algorithm, supports expansion | sm2/sm3/sm4/md5 and other algorithms                           |
| Desensitization, encryption/decryption multiple-choice configurable | ‚úÖ**Supports desensitization, encryption/decryption switch, supports zero-impact encryption/decryption failure** | **‚ùåNot supported**                                           |
| New additions do not change source object reference      | ‚úÖ**Supported**, encryption/decryption process is deep copy, supports save operations followed by continued object manipulation, and object reference is not encrypted | **‚ùåNot supported**                                           |
| After addition, if the same object reference is modified, then updated, encryption works properly | **Supported**                                                | **Supported**                                                |
| Extensible encryption algorithm, encryption/decryption type processor, desensitization type processor | **‚úÖSupported**                                               | **‚ùåNot supported**                                           |
| Custom desensitization identifier, start position, end position | ‚úÖ**Supported**                                               | ‚ùå**Not supported**                                           |
| Complete unit test cases                                 | ‚úÖ**Complete unit test cases**                                | ‚ùå**None**                                                    |

## Usage

### Built-in Desensitization Rules

The component has built-in 9 desensitization rules

- `MaskType.NO_MASK`-No desensitization
- `MaskType.NAME_MASK`-Name desensitization
- `MaskType.PHONE_MASK`-Phone desensitization
- `MaskType.IDCARD_MASK`-ID card desensitization
- `MaskType.EMAIL_MASK`-Email desensitization
- `MaskType.BANKCARD_MASK`-Bank card desensitization
- `MaskType.ADDRESS_MASK`-Address desensitization
- `MaskType.ALL_MASK`-Full desensitization
- `MaskType.CUSTOM_MASK`-Custom desensitization

All desensitization rules support custom desensitization symbols, default is *, where custom desensitization allows users to select the start and end positions of the desensitized field

### Desensitization Usage-Single Desensitization

For fields that need desensitization, use `@Masked` for identification

Such as the following entity

```java
@Data
public class TestVO implements Serializable {

    private static final long serialVersionUID = 1142843493987112387L;

    /**
     * Primary key id
     */
    private Long id;

    /**
     * Name
     */
    @Masked(type = MaskType.NAME_MASK)
    private String name;

    /**
     * ID card number
     */
    @Masked(type = MaskType.IDCARD_MASK)
    private String idCard;

    /**
     * Phone number
     */
    @Masked(type = MaskType.PHONE_MASK)
    private String phone;

    /**
     * Custom identifier field
     */
    @Masked(type = MaskType.CUSTOM_MASK, start = 2, end = 5, symbol = "#")
    private String customFiled;
}
```

In the `Controller` layer, annotate with `@Desensitizationed` annotation to identify method-level desensitization

If this annotation is not included, even if the entity class contains desensitization annotations, automatic desensitization will not occur when returning to the frontend, used for finer-grained desensitization control

As follows

```java
/**
 * Get desensitized data-base type
 *
 * @return TestVO
 */
@PostMapping("/baseType")
@Desensitizationed
public TestVO testBase() {
    TestVersionDO result = testVersionDOService.testDesensite();
    return RpamisBeanUtil.copy(result, TestVO.class);
}
```

### Desensitization Usage-Nested Desensitization

Nested desensitization is used for cases where the entity field also contains desensitized entities. For fields that require nested desensitization, use the `@NestedMasked` annotation

Sample entity class as follows

```java
@Data
public class TestNestVO implements Serializable {

    private static final long serialVersionUID = -5559148350211559748L;

    /**
     * Primary key id
     */
    private Long id;

    /**
     * Name
     */
    @Masked(type = MaskType.NAME_MASK)
    private String name;

    /**
     * Nested validation-Direct return entity
     */
    @NestedMasked
    private TestVO testVO;

    /**
     * Nested validation-Return List
     */
    @NestedMasked
    private List<TestVO> testVOList;

    /**
     * Nested validation-Return Map
     */
    @NestedMasked
    private Map<String, TestVO> testVOMap;
}
```

The above entity will desensitize name, as well as all fields marked with `@NestedMasked` in testVO, testVOList, testVOMap entities

Outer layer usage is consistent with single desensitization

As follows

```java
/**
 * Get desensitized data-nested desensitization-base
 *
 * @return TestNestVO
 */
@PostMapping("/nest/baseType")
@Desensitizationed
public TestNestVO testNestVO() {
    TestVersionDO testVersionDO = testVersionDOService.testDesensite();
    TestVO test = RpamisBeanUtil.copy(testVersionDO, TestVO.class);
    TestNestVO testNestVO = new TestNestVO();
    testNestVO.setId(1L);
    testNestVO.setName("Zhang San");
    testNestVO.setTestVO(test);
    return testNestVO;
}
```

### Encryption/Decryption Usage

For entities passed to `Mybatis Mapper` or `Mybatis Plus` built-in `Insert/update/Wrapper` operations, fields will be automatically encrypted when storing to database

For `Mybatis/Mybatis Plus` query operations, encrypted fields will be automatically decrypted when retrieving from database

Encryption/decryption fields are marked with `@SecurityField` annotation. When yml configuration enables encryption/decryption, no additional annotations are needed, the process is fully automated

Entity as follows

```java
@TableName(value ="test_version")
@Data
public class TestVersionDO implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * Primary key id
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    /**
     * Name
     */
    @TableField(value = "name")
    @SecurityField
    private String name;

    /**
     * ID card number
     */
    @TableField(value = "id_card")
    @SecurityField
    private String idCard;

    /**
     * Phone
     */
    @TableField(value = "phone")
    @SecurityField
    private String phone;

    /**
     * Version number
     */
    @TableField(value = "version")
    private Integer version;

}
```

Note: Encrypted fields are longer, please pay attention to the database length of encrypted fields, for example, ID card is 18 digits, after encryption it can reach 64 digits

### Unit Test Cases

[Click here](https://github.com/benym/rpamis-security/blob/master/rpamis-security-test/src/test/java/com/rpamis/security/test) to find the corresponding unit test cases

| Test Case                                                  | Test Result |
| ---------------------------------------------------------- | ----------- |
| Mybatis-plus insert interface, insert data then query, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis-plus saveBatch interface, insert data then query, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis-plus update interface, insert data then query, then update data, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis-plus updateWrapper, insert data then query, then update data, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis-plus delete interface, insert data then delete, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis custom insert interface, insert data then query, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis custom insertBatch interface (foreach dynamic SQL concatenation), insert data then query, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis custom update interface, insert data then query, then update data, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Mybatis custom delete interface, insert data then delete, simultaneously verify encryption/decryption results | ‚úÖPassed     |
| Get desensitized data-Single custom entity                | ‚úÖPassed     |
| Get desensitized data-List type                           | ‚úÖPassed     |
| Get desensitized data-Map type                            | ‚úÖPassed     |
| Get desensitized data-Unified return body (generic custom entity) | ‚úÖPassed     |
| Get desensitized data-Unified return body (no generics)   | ‚úÖPassed     |
| Get desensitized data-Nested desensitization-Single custom entity | ‚úÖPassed     |
| Get desensitized data-Nested desensitization-List type    | ‚úÖPassed     |
| Get desensitized data-Nested desensitization-Map type     | ‚úÖPassed     |
| Get decrypted data-Mybatis-plus-selectOne                 | ‚úÖPassed     |
| Get decrypted data-Mybatis-plus-selectList                | ‚úÖPassed     |
| Get decrypted data-Mybatis-selectOne                      | ‚úÖPassed     |
| Get decrypted data-Mybatis-selectList                     | ‚úÖPassed     |
| Get decrypted data-Mybatis-selectMap                      | ‚úÖPassed     |
| New additions do not change source object reference-Deep copy | ‚úÖPassed     |
| After addition, if the same object reference is modified, then updated, encryption works properly | ‚úÖPassed     |
| Decrypt existing unencrypted data, support original value return | ‚úÖPassed     |
| Prevent duplicate encryption                              | ‚úÖPassed     |
| Compatible with encryption/decryption in versions below 1.0.3 | ‚úÖPassed     |
| Nested decryption                                         | ‚úÖPassed     |
| Encryption/decryption cache isolation                     | ‚úÖPassed     |
| Normal handling when query data returns null              | ‚úÖPassed     |
| Default security algorithm-Insert data return original value | ‚úÖPassed     |
| SM4 key is empty-Throw prompt                             | ‚úÖPassed     |
| SM4 key length less than 16 digits-Throw prompt           | ‚úÖPassed     |